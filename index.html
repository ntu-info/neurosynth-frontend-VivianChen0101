<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Neurosynth AJAX Frontend</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
  <div class="max-w-6xl w-full bg-white shadow-md rounded-2xl p-8 space-y-6 relative">
    <h1 class="text-3xl font-bold text-center text-gray-800">🧠 Neurosynth AJAX Frontend</h1>

    <!-- === 使用說明 === -->
    <div class="text-gray-600 text-sm text-center leading-relaxed border border-gray-200 bg-gray-50 p-3 rounded-lg shadow-sm">
      <p><b>1️⃣ Get All Terms</b> → 顯示資料庫中所有可用的心理學術語。</p>
      <p><b>2️⃣ Get Related Terms</b> → 查詢與輸入術語相關的詞彙與相似度。</p>
      <p><b>3️⃣ Query Studies</b> → 查詢符合條件的研究文獻資料。</p>
    </div>

    <!-- Section 1 -->
    <section>
      <h2 class="text-xl font-semibold mb-2 text-gray-700">1️⃣ Get All Terms</h2>
      <button id="btnAllTerms" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
        Fetch /terms
      </button>
    </section>

    <!-- Section 2 -->
    <section>
      <h2 class="text-xl font-semibold mb-2 text-gray-700">2️⃣ Get Related Terms</h2>
      <input id="termInput" class="border border-gray-300 p-2 w-full rounded mb-2" placeholder="Enter term, e.g. amygdala" />
      <button id="btnSingleTerm" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
        Fetch /terms/&lt;term&gt;
      </button>
    </section>

    <!-- Section 3 -->
    <section>
      <h2 class="text-xl font-semibold mb-2 text-gray-700">3️⃣ Query Studies</h2>
      <input id="queryInput" class="border border-gray-300 p-2 w-full rounded mb-2" placeholder='Enter logical query, e.g. amygdala not emotion' />
      <button id="btnQuery" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
        Fetch /query/&lt;query&gt;/studies
      </button>
    </section>

    <!-- Output -->
    <section>
      <h2 class="text-xl font-semibold mb-2 text-gray-700">📄 API Response</h2>
      <div id="output" class="bg-gray-100 p-4 rounded h-[550px] overflow-auto text-sm text-gray-800"></div>
    </section>

    <!-- Scroll to top button -->
    <button id="scrollTopBtn" class="hidden fixed bottom-8 right-8 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition-opacity duration-300">
      ⬆️
    </button>
  </div>

  <script>
    const out = document.getElementById("output");
    const scrollTopBtn = document.getElementById("scrollTopBtn");

    async function fetchData(url, type) {
      out.innerHTML = `<p class="text-gray-600">Requesting... <span class="font-mono">${url}</span></p>`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
        const data = await resp.json();

        if (type === "terms") renderTerms(data);
        else if (type === "related") renderRelated(data);
        else if (type === "studies") renderStudies(data);
      } catch (err) {
        out.innerHTML = `<p class="text-red-600 font-semibold">❌ ${err.message}</p>`;
      }
    }

    // === A–Z sticky selector ===
    function createAZButtons(containerSelector) {
      const letters = [...Array(26)].map((_, i) => String.fromCharCode(65 + i));
      const div = document.createElement("div");
      div.className = "sticky top-0 bg-gray-100 z-10 flex flex-wrap justify-center mb-2 space-x-1 py-1 shadow-sm";
      div.innerHTML = letters.map(l => `
        <button data-letter="${l}" class="text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-sm">${l}</button>
      `).join("");

      div.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const target = document.querySelector(`${containerSelector} [data-term^="${btn.dataset.letter.toLowerCase()}"]`);
          if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
      return div;
    }

    // === Render: /terms ===
    function renderTerms(data) {
      if (!data.terms || data.terms.length === 0)
        return out.innerHTML = `<p class="text-gray-600">No information found for this query. Please try another term.</p>`;

      const wrapper = document.createElement("div");
      wrapper.id = "termsTable";

      const az = createAZButtons("#termsTable");
      wrapper.appendChild(az);

      const table = document.createElement("table");
      table.className = "table-auto w-full border-collapse";
      table.innerHTML = `
        <thead class="bg-blue-200"><tr><th class="px-3 py-1 text-left">Term</th></tr></thead>
        <tbody>
          ${data.terms.map(t => `<tr><td class="border px-3 py-1" data-term="${t.toLowerCase()}">${t}</td></tr>`).join("")}
        </tbody>
      `;
      wrapper.appendChild(table);
      out.innerHTML = "";
      out.appendChild(wrapper);
    }

    // === Render: /terms/<term> ===
    function renderRelated(data) {
      if (!data.related || data.related.length === 0)
        return out.innerHTML = `<p class="text-gray-600">No information found for this query. Please try another term.</p>`;

      const wrapper = document.createElement("div");
      wrapper.id = "relatedTable";

      const terms = data.related.map(r => r.term);
      const az = createAZButtons("#relatedTable");
      wrapper.appendChild(az);

      const table = document.createElement("table");
      table.className = "table-auto w-full border-collapse";
      table.innerHTML = `
        <thead class="bg-green-200">
          <tr><th>Term</th><th>Total Count</th><th>Similarity</th></tr>
        </thead>
        <tbody>
          ${data.related.map(r => `
            <tr>
              <td class="border px-3 py-1" data-term="${r.term.toLowerCase()}">${r.term}</td>
              <td class="border px-3 py-1">${r.co_count}</td>
              <td class="border px-3 py-1">${r.jaccard.toFixed(4)}</td>
            </tr>`).join("")}
        </tbody>
      `;
      wrapper.appendChild(table);
      out.innerHTML = "";
      out.appendChild(wrapper);
    }

    // === Render: /query/.../studies ===
    function renderStudies(data) {
      if (!data.results || data.results.length === 0)
        return out.innerHTML = `<p class="text-gray-600">No information found for this query. Please try another term.</p>`;

      const rows = data.results.map(r => `
        <tr>
          <td class="border px-3 py-1">${r.id || "-"}</td>
          <td class="border px-3 py-1">${r.study_id || "-"}</td>
          <td class="border px-3 py-1">${r.contrast_id || "-"}</td>
          <td class="border px-3 py-1">${r.title || "-"}</td>
          <td class="border px-3 py-1">${r.authors || "-"}</td>
          <td class="border px-3 py-1">${r.journal || "-"}</td>
          <td class="border px-3 py-1">${r.year || "-"}</td>
        </tr>`).join("");

      out.innerHTML = `
        <p class="text-gray-500 mb-2">Found ${data.count} studies.</p>
        <table class="table-auto w-full border-collapse text-xs">
          <thead class="bg-purple-200">
            <tr>
              <th>ID</th><th>Study ID</th><th>Contrast ID</th>
              <th>Title</th><th>Authors</th><th>Journal</th><th>Year</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    // === Buttons ===
    document.getElementById("btnAllTerms").addEventListener("click", () => {
      fetchData("https://mil.psy.ntu.edu.tw:5000/terms", "terms");
    });

    document.getElementById("btnSingleTerm").addEventListener("click", () => {
      const term = document.getElementById("termInput").value.trim();
      if (!term)
        return out.innerHTML = `<p class="text-red-600">Please enter a term!</p>`;
      fetchData(`https://mil.psy.ntu.edu.tw:5000/terms/${encodeURIComponent(term)}`, "related");
    });

    document.getElementById("btnQuery").addEventListener("click", () => {
      const q = document.getElementById("queryInput").value.trim();
      if (!q)
        return out.innerHTML = `<p class="text-red-600">Please enter a query string!</p>`;
      fetchData(`https://mil.psy.ntu.edu.tw:5000/query/${encodeURIComponent(q)}/studies`, "studies");
    });

    // === Scroll to top button logic ===
    const container = document.querySelector(".max-w-6xl");
    container.addEventListener("scroll", toggleScrollBtn);
    window.addEventListener("scroll", toggleScrollBtn);

    function toggleScrollBtn() {
      if (window.scrollY > 200 || container.scrollTop > 200) {
        scrollTopBtn.classList.remove("hidden");
      } else {
        scrollTopBtn.classList.add("hidden");
      }
    }

    scrollTopBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  </script>
</body>
</html>
